name: Test Invoices

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-invoices:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd syspro-erp-frontend
          npm ci

      - name: Build
        run: |
          npm --prefix ./syspro-erp-frontend run build

      - name: Start server
        env:
          # Provide DB/Neon connection string and any other required secrets in repo settings
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          npm --prefix ./syspro-erp-frontend run start &
          # wait for server to be ready
          for i in {1..30}; do
            if curl -sS http://localhost:3000/api/health >/dev/null 2>&1; then
              echo "server ready"; break
            fi
            echo "waiting for server... ($i)"; sleep 2
          done

      - name: Run invoice tests
        env:
          BASE_URL: http://localhost:3000
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          npm --prefix ./syspro-erp-frontend run test:invoices
